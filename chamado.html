<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Sistema CPM - Atendimento</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { background-color: #0b3c66; color: white; font-family: Arial, sans-serif; text-align: center; padding: 20px; margin: 0; }
        h1 { font-size: 38px; margin: 10px 0; }
        h2 { font-size: 22px; color: #ff0000; margin: 5px 0; font-weight: bold; }
        
        .form-container { background: rgba(255, 255, 255, 0.1); padding: 20px; border-radius: 8px; width: 550px; margin: 0 auto; border: 1px solid rgba(255,255,255,0.2); }
        .status-grande { font-size: 40px; color: #ff0000; font-weight: bold; margin: 25px 0; min-height: 60px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); line-height: 1.2; }
        
        .btn-acao { background-color: #d50000; color: white; border: none; padding: 15px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; text-transform: uppercase; transition: 0.3s; border-radius: 4px; }
        .btn-acao:hover { background-color: #ff1a1a; transform: scale(1.02); }
        
        .btn-relatorio { background-color: #28a745; margin-top: 20px; width: 350px; border-radius: 5px; color: white; border: none; padding: 10px; font-weight: bold; cursor: pointer; }

        .fila-box { background: white; color: #333; width: 95%; max-width: 900px; margin: 30px auto; padding: 15px; border-radius: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .fila-item { display: grid; grid-template-columns: 100px 2fr 1.5fr 1fr; border-bottom: 1px solid #ddd; padding: 10px; font-size: 14px; text-align: left; }
        .header { font-weight: bold; background: #eee; border-bottom: 2px solid #0b3c66; }
        
        .senha-p { color: #e67e22; font-weight: bold; } /* Cor para destaque de prioridade */
        .senha-comum { color: #d50000; }
        
        .badge-turno { font-size: 12px; opacity: 0.8; margin-top: 12px; display: block; font-style: italic; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; }
        .aviso-prioridade { color: #ffc107; font-weight: bold; display: block; margin-bottom: 5px; font-size: 14px; }
    </style>
</head>
<body>

    <h1>GOVERNO DO ESTADO DA BAHIA</h1>
    <h2>SEC - ATENDIMENTO CPM (CHAMADA)</h2>

    <div class="form-container">
        <div id="display-chamada" class="status-grande">AGUARDANDO...</div>
        
        <div id="alerta-fila"></div>

        <button class="btn-acao" onclick="chamarAlternado()">CHAMAR PR√ìXIMO</button>
        
        <button class="btn-acao" style="background:#0056b3" onclick="chamarInterno()">CHAMAR INTERNO</button>
        
        <button class="btn-relatorio" onclick="exportarExcel()">üìä BAIXAR RELAT√ìRIO EXCEL</button>
        
        <span id="proximo-tipo" class="badge-turno">Carregando fila...</span>
    </div>

    <div class="fila-box">
        <div style="font-weight: bold; margin-bottom: 10px; font-size: 18px; text-align: left; color: #0b3c66;">Fila de Espera em Tempo Real:</div>
        <div id="fila-atendimento"></div>
    </div>

    <script>
        const canal = new BroadcastChannel('fluxo_cpm');
        const canalTV = new BroadcastChannel('senha_channel');
        let db;
        let proximoEhEfetivo = true;

        const request = indexedDB.open("SistemaCPM_DB", 1);
        request.onsuccess = e => { db = e.target.result; carregarFila(); };

        function carregarFila() {
            if (!db) return;
            const store = db.transaction("atendimentos", "readonly").objectStore("atendimentos");
            store.getAll().onsuccess = (e) => {
                const todos = e.target.result.filter(i => i.status === "AGUARDANDO");
                
                // Ordenar para exibi√ß√£o: Priorit√°rios primeiro
                todos.sort((a, b) => {
                    if (a.prioridade === b.prioridade) return a.timestamp - b.timestamp;
                    return a.prioridade ? -1 : 1;
                });

                let html = `<div class="fila-item header"><span>Senha</span><span>Nome</span><span>Assunto</span><span>V√≠nculo</span></div>`;
                todos.forEach(p => {
                    const classe = p.prioridade ? "senha-p" : "senha-comum";
                    html += `<div class="fila-item"><b class="${classe}">${p.senha}</b><span>${p.nome} ${p.prioridade ? '‚≠ê' : ''}</span><span>${p.assunto}</span><span>${p.tipo}</span></div>`;
                });
                
                document.getElementById('fila-atendimento').innerHTML = todos.length ? html : "Ningu√©m aguardando.";
                
                atualizarIndicadorTurno(todos);
            };
        }

        function atualizarIndicadorTurno(fila) {
            const temPrioridade = fila.some(i => i.prioridade);
            const alertaDiv = document.getElementById('alerta-fila');
            
            if (temPrioridade) {
                alertaDiv.innerHTML = `<span class="aviso-prioridade">‚ö†Ô∏è EXISTE PRIORIDADE NA FILA</span>`;
                document.getElementById('proximo-tipo').innerText = `A pr√≥xima chamada ser√°: PRIORIDADE`;
            } else {
                alertaDiv.innerHTML = "";
                const txt = proximoEhEfetivo ? "EFETIVO" : "REDA";
                document.getElementById('proximo-tipo').innerText = `Turno atual (se n√£o houver prioridade): ${txt}`;
            }
        }

        function chamarAlternado() {
            const store = db.transaction("atendimentos", "readwrite").objectStore("atendimentos");
            store.getAll().onsuccess = (e) => {
                const fila = e.target.result.filter(i => i.status === "AGUARDANDO");
                if (fila.length === 0) return alert("N√£o h√° ningu√©m aguardando!");

                // 1. PRIORIDADE ABSOLUTA (Regra de Ouro)
                const prioridades = fila.filter(i => i.prioridade).sort((a,b) => a.timestamp - b.timestamp);
                
                let selecionado;

                if (prioridades.length > 0) {
                    selecionado = prioridades[0];
                    // Quando chama prioridade, n√£o altera a vez do Efetivo/Reda
                } else {
                    // 2. L√ìGICA DE ALTERN√ÇNCIA (Caso n√£o haja prioridade)
                    const efetivos = fila.filter(i => i.tipo === 'EFETIVO').sort((a,b) => a.timestamp - b.timestamp);
                    const redas = fila.filter(i => i.tipo === 'REDA').sort((a,b) => a.timestamp - b.timestamp);

                    if (proximoEhEfetivo) {
                        selecionado = efetivos[0] || redas[0];
                    } else {
                        selecionado = redas[0] || efetivos[0];
                    }

                    // Alternar o turno apenas se ambos existirem na fila
                    if (efetivos.length > 0 && redas.length > 0) {
                        proximoEhEfetivo = !proximoEhEfetivo;
                    }
                }

                if (selecionado) {
                    finalizarChamada(selecionado);
                }
            };
        }

        function chamarInterno() {
            const store = db.transaction("atendimentos", "readwrite").objectStore("atendimentos");
            store.getAll().onsuccess = (e) => {
                const selecionado = e.target.result.find(i => i.status === "AGUARDANDO" && i.tipo === 'INTERNO');
                if (selecionado) {
                    finalizarChamada(selecionado);
                } else {
                    alert("N√£o h√° atendimentos INTERNOS na fila!");
                }
            };
        }

        function finalizarChamada(selecionado) {
            selecionado.status = "ATENDIDO";
            selecionado.horaChamado = new Date().toLocaleTimeString();
            
            const trans = db.transaction("atendimentos", "readwrite");
            trans.objectStore("atendimentos").put(selecionado);
            
            trans.oncomplete = () => {
                document.getElementById('display-chamada').innerText = `${selecionado.senha} - ${selecionado.nome}`;
                canalTV.postMessage(selecionado);
                canal.postMessage({ acao: 'atualizar' });
                carregarFila();
            };
        }

        function exportarExcel() {
            db.transaction("atendimentos", "readonly").objectStore("atendimentos").getAll().onsuccess = (e) => {
                const dados = e.target.result.map(i => ({
                    Senha: i.senha, 
                    Nome: i.nome, 
                    Matr√≠cula: i.matricula, 
                    Telefone: i.telefone, 
                    Assunto: i.assunto, 
                    V√≠nculo: i.tipo, 
                    Prioridade: i.prioridade ? "SIM" : "N√ÉO",
                    Chegada: i.horaGeracao, 
                    Chamado: i.horaChamado || "N√£o chamado"
                }));
                const ws = XLSX.utils.json_to_sheet(dados);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Atendimentos");
                XLSX.writeFile(wb, `Relatorio_CPM_${new Date().toLocaleDateString().replace(/\//g, '-')}.xlsx`);
            };
        }

        canal.onmessage = () => carregarFila();
    </script>
</body>
</html>